package io.github.rrbca2022.pms.services;

import io.github.rrbca2022.pms.entity.Category;
import io.github.rrbca2022.pms.entity.Medicine;
import io.github.rrbca2022.pms.entity.MedicineBatch;
import io.github.rrbca2022.pms.repository.MedicineBatchRepository;
import io.github.rrbca2022.pms.repository.MedicineRepository;
import io.github.rrbca2022.pms.utils.PMSLogger;
import lombok.RequiredArgsConstructor;
import org.springframework.stereotype.Service;

import java.util.List;

@Service
@RequiredArgsConstructor()
public class MedicineService {
    private final CategoryService categoryService;
    private final MedicineRepository medicineRepository;
    private final MedicineBatchRepository batchRepository;

    public List<Medicine> getAllMedicines(){return medicineRepository.findAll();}

    public Medicine getMedicineById(String id){return medicineRepository.findById(id).orElse(null);}

    public Medicine saveMedicine(Medicine medicine)
    {
        PMSLogger.debug("Saving Medicine: " + medicine.getId() + " - " + medicine.getName());
        String catId = medicine.getCategory().getId();
        Category category = categoryService.getCategoryById(catId);
        medicine.setCategory(category);
        Medicine savedMedicine = medicineRepository.save(medicine);
        PMSLogger.debug("Saved Medicine: " + medicine.getId() + " - " + medicine.getName());

        // 3. Create the Initial Batch from the Medicine form data
        // This makes sure your FEFO algorithm has a record to track.
        MedicineBatch initialBatch = new MedicineBatch();
        initialBatch.setMedicine(savedMedicine);
        initialBatch.setExpiryDate(medicine.getExpDate());
        initialBatch.setStockQuantity(medicine.getQty());

        // Note: 'batchNumber' will be auto-generated by @PrePersist in the entity
        // if you don't set it here.

        batchRepository.save(initialBatch);

        return savedMedicine;
    }

    public void deleteMedicine(String id){ medicineRepository.deleteById(id);}




}
